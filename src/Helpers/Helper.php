<?php
/**
 * Created by PhpStorm.
 * User: ewerson
 * Date: 11/07/18
 * Time: 13:37
 */

namespace Ewersonfc\Linhadigitavel\Helpers;

/**
 * Class Helper
 * @package Ewersonfc\Linhadigitavel\Helpers
 */
class Helper
{
    /**
     * @param $text
     * @return null|string|string[]
     */
    public static function prepair($text)
    {
        return preg_replace("/[^0-9\.]/", "", $text);
    }

    /**
     * @param $text
     * @return null|string|string[]
     */
    public static function prepairIMG($text)
    {
        $data = preg_replace("/[^0-9\-]/", "", $text);
        return explode('-', $data);
    }

    /**
     * @param $string
     * @return mixed
     */
    public static function extract($string)
    {
        preg_match('[\d{5}\.\d{10}\.\d{11}\.\d{21}]', $string, $match);
        return $match;
    }

    /**
     * @param array $select
     * @return array
     */
    public static function extractIMG(array $select)
    {
        $matches = [];
        foreach ($select as $data) {
            if(strlen($data) > 43) {
                foreach(self::bancos() as $banco) {
                    preg_match("/{$banco}9\d{43}/", $data, $match);
                    if (count($match) == 0)
                        continue;

                    $digito = self::verifyDigit($match[0]);
                    if($digito == substr($match[0],9, 1))
                        $matches[] = $match[0];
                }
            }
        }
        return $matches;
    }

    /**
     * @return array
     */
    private static function bancos()
    {
        return [
            '654' => '654',
            '246' => '246',
            '025' => '025',
            '641' => '641',
            '213' => '213',
            '019' => '019',
            '029' => '029',
            '000' => '000',
            '740' => '740',
            '107' => '107',
            '031' => '031',
            '739' => '739',
            '096' => '096',
            '318' => '318',
            '752' => '752',
            '248' => '248',
            '218' => '218',
            '065' => '065',
            '036' => '036',
            '204' => '204',
            '394' => '394',
            '237' => '237',
            '225' => '225',
            'M15' => 'M15',
            '208' => '208',
            '044' => '044',
            '263' => '263',
            '473' => '473',
            '412' => '412',
            '040' => '040',
            '745' => '745',
            'M08' => 'M08',
            '241' => '241',
            'M19' => 'M19',
            '215' => '215',
            '756' => '756',
            '748' => '748',
            '075' => '075',
            '721' => '721',
            '222' => '222',
            '505' => '505',
            '229' => '229',
            '266' => '266',
            '003' => '003',
            '083-3' => '083-3',
            'M21' => 'M21',
            '707' => '707',
            '300' => '300',
            '495' => '495',
            '494' => '494',
            'M06' => 'M06',
            '024' => '024',
            '456' => '456',
            '214' => '214',
            '001' => '001',
            '047' => '047',
            '037' => '037',
            '039' => '039',
            '041' => '041',
            '004' => '004',
            '265' => '265',
            'M03' => 'M03',
            '224' => '224',
            '626' => '626',
            'M18' => 'M18',
            '233' => '233',
            '734' => '734',
            'M07' => 'M07',
            '612' => '612',
            'M22' => 'M22',
            '063' => '063',
            'M11' => 'M11',
            '604' => '604',
            '320' => '320',
            '653' => '653',
            '630' => '630',
            '077-9' => '077-9',
            '249' => '249',
            'M09' => 'M09',
            '184' => '184',
            '479' => '479',
            '376' => '376',
            '074' => '074',
            '217' => '217',
            '076' => '076',
            '757' => '757',
            '600' => '600',
            '212' => '212',
            'M12' => 'M12',
            '389' => '389',
            '746' => '746',
            'M10' => 'M10',
            '738' => '738',
            '066' => '066',
            '243' => '243',
            '045' => '045',
            'M17' => 'M17',
            '623' => '623',
            '611' => '611',
            '613' => '613',
            '094-2' => '094-2',
            '643' => '643',
            '724' => '724',
            '735' => '735',
            '638' => '638',
            'M24' => 'M24',
            '747' => '747',
            '088' - 4 => '088-4',
            '356' => '356',
            '633' => '633',
            '741' => '741',
            'M16' => 'M16',
            '072' => '072',
            '453' => '453',
            '422' => '422',
            '033' => '033',
            '250' => '250',
            '743' => '743',
            '749' => '749',
            '366' => '366',
            '637' => '637',
            '012' => '012',
            '464' => '464',
            '082-5' => '082-5',
            'M20' => 'M20',
            'M13' => 'M13',
            '634' => '634',
            'M14' => 'M14',
            'M23' => 'M23',
            '655' => '655',
            '610' => '610',
            '370' => '370',
            '021' => '021',
            '719' => '719',
            '755' => '755',
            '744' => '744',
            '073' => '073',
            '078' => '078',
            '069' => '069',
            '070' => '070',
            '092-2' => '092-2',
            '104' => '104',
            '477' => '477',
            '081-7' => '081-7',
            '097-3' => '097-3',
            '085-x' => '085-x',
            '099-x' => '099-x',
            '090-2' => '090-2',
            '089-2' => '089-2',
            '087-6' => '087-6',
            '098-1' => '098-1',
            '487' => '487',
            '751' => '751',
            '064' => '064',
            '062' => '062',
            '399' => '399',
            '168' => '168',
            '492' => '492',
            '652' => '652',
            '341' => '341',
            '079' => '079',
            '488' => '488',
            '014' => '014',
            '753' => '753',
            '086-8' => '086-8',
            '254' => '254',
            '409' => '409',
            '230' => '230',
            '091-4' => '091-4',
            '084' => '084',
        ];
    }

    /**
     * @param $linha
     * @return bool|int
     */
    public static function verifyDigit($linha)
    {
        $factor = substr($linha, 0, 9);
        $factorArray = str_split($factor);
        if(!$factor)
            return false;

        $result = [];
        for($i=0; $i <= 8; $i++) {
            $result[] =$factorArray[$i]*($i% 2 == 0?2:1);
        }

        $newResult = array_map(function($item){
            if($item >= 10)
                return array_sum(str_split($item));
            return $item;
        }, $result);

        $dig = (10-(array_sum($newResult) % 10));

        if($dig==10) { 
            $dig=0; 
        }
        return $dig;
    }
}